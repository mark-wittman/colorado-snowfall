<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Colorado Snowpack Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="data.js"></script>
<style>
:root {
  --bg-deep: #0B1220;
  --bg-card: #111D2E;
  --bg-card-hover: #162538;
  --border: #1E3048;
  --text-primary: #E8EDF3;
  --text-secondary: #8899AE;
  --text-muted: #556677;
  --ice: #7DD3FC;
  --ice-dim: rgba(125, 211, 252, 0.15);
  --ice-glow: rgba(125, 211, 252, 0.08);
  --danger: #F87171;
  --danger-dim: rgba(248, 113, 113, 0.15);
  --amber: #FBBF24;
  --amber-dim: rgba(251, 191, 36, 0.12);
  --green: #4ADE80;
  --green-dim: rgba(74, 222, 128, 0.12);
  --envelope-outer: rgba(125, 211, 252, 0.06);
  --envelope-inner: rgba(125, 211, 252, 0.12);
  --font-display: 'Barlow Condensed', sans-serif;
  --font-body: 'DM Sans', sans-serif;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg-deep);
  color: var(--text-primary);
  font-family: var(--font-body);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Topographic background texture */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    repeating-conic-gradient(from 0deg at 50% 50%, transparent 0deg, rgba(125,211,252,0.01) 1deg, transparent 2deg) 0 0 / 400px 400px,
    radial-gradient(ellipse at 20% 0%, rgba(125,211,252,0.04) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 100%, rgba(125,211,252,0.03) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

.container {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem 1.5rem 4rem;
  position: relative;
  z-index: 1;
}

/* Header */
header {
  margin-bottom: 2.5rem;
  border-bottom: 1px solid var(--border);
  padding-bottom: 1.5rem;
}

header h1 {
  font-family: var(--font-display);
  font-weight: 700;
  font-size: 2.8rem;
  letter-spacing: -0.02em;
  text-transform: uppercase;
  line-height: 1;
  background: linear-gradient(135deg, var(--text-primary) 0%, var(--ice) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.header-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.header-meta {
  font-size: 0.8rem;
  color: var(--text-muted);
  font-family: var(--font-body);
  text-align: right;
}

.header-meta span { color: var(--text-secondary); }

.water-year-badge {
  display: inline-block;
  background: var(--ice-dim);
  color: var(--ice);
  padding: 0.25rem 0.75rem;
  border-radius: 2px;
  font-family: var(--font-display);
  font-weight: 600;
  font-size: 0.85rem;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  margin-bottom: 0.5rem;
}

/* Hero Cards */
.hero-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
  margin-bottom: 2rem;
}

.hero-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1.25rem 1.5rem;
  position: relative;
  overflow: hidden;
  transition: background 0.2s;
}

.hero-card:hover { background: var(--bg-card-hover); }

.hero-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
}

.hero-card.deficit::before { background: var(--danger); }
.hero-card.pct::before { background: var(--amber); }
.hero-card.swe::before { background: var(--ice); }
.hero-card.peak::before { background: var(--text-muted); }

.hero-label {
  font-family: var(--font-display);
  font-size: 0.75rem;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 0.5rem;
}

.hero-value {
  font-family: var(--font-display);
  font-weight: 700;
  font-size: 2.8rem;
  line-height: 1;
  letter-spacing: -0.02em;
}

.hero-card.swe .hero-value { color: var(--ice); }
.hero-card.deficit .hero-value { color: var(--danger); }
.hero-card.pct .hero-value { color: var(--amber); }
.hero-card.peak .hero-value { color: var(--text-primary); }

.hero-unit {
  font-size: 1.4rem;
  font-weight: 400;
  opacity: 0.6;
}

.hero-sub {
  font-size: 0.78rem;
  color: var(--text-secondary);
  margin-top: 0.4rem;
}

/* Main Chart Section */
.chart-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  gap: 0.75rem;
}

.chart-title {
  font-family: var(--font-display);
  font-weight: 700;
  font-size: 1.3rem;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.chart-controls {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  flex-wrap: wrap;
}

.chart-controls label {
  font-size: 0.75rem;
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.35rem;
}

.chart-controls input[type="checkbox"] {
  accent-color: var(--ice);
  width: 14px;
  height: 14px;
}

.year-select {
  background: var(--bg-deep);
  color: var(--text-secondary);
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 0.3rem 0.5rem;
  font-size: 0.75rem;
  font-family: var(--font-body);
  max-width: 200px;
}

.chart-wrapper {
  position: relative;
  height: 420px;
}

/* Analysis Grid */
.analysis-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  margin-bottom: 1.5rem;
}

.panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1.5rem;
}

.panel-title {
  font-family: var(--font-display);
  font-weight: 700;
  font-size: 1.1rem;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  margin-bottom: 1rem;
  color: var(--text-primary);
}

/* Catch-up panel */
.catchup-stat {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  padding: 0.7rem 0;
  border-bottom: 1px solid var(--border);
}

.catchup-stat:last-child { border-bottom: none; }

.catchup-stat-label {
  font-size: 0.8rem;
  color: var(--text-secondary);
}

.catchup-stat-value {
  font-family: var(--font-display);
  font-weight: 700;
  font-size: 1.3rem;
  letter-spacing: -0.01em;
}

.rate-compare {
  margin-top: 1.25rem;
  background: var(--bg-deep);
  border-radius: 4px;
  padding: 1rem;
}

.rate-bar-group {
  margin-bottom: 0.75rem;
}

.rate-bar-group:last-child { margin-bottom: 0; }

.rate-bar-label {
  font-size: 0.7rem;
  color: var(--text-secondary);
  margin-bottom: 0.3rem;
  display: flex;
  justify-content: space-between;
}

.rate-bar-track {
  height: 20px;
  background: rgba(255,255,255,0.04);
  border-radius: 2px;
  overflow: hidden;
}

.rate-bar-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 1s ease-out;
  min-width: 2px;
}

.rate-bar-fill.needed { background: var(--amber); }
.rate-bar-fill.actual { background: var(--ice); }

/* Forecast panel */
.forecast-chart-wrapper {
  height: 200px;
  margin-bottom: 1rem;
}

.forecast-summary {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
}

.forecast-stat {
  background: var(--bg-deep);
  border-radius: 4px;
  padding: 0.75rem;
  text-align: center;
}

.forecast-stat-label {
  font-size: 0.65rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 0.25rem;
}

.forecast-stat-value {
  font-family: var(--font-display);
  font-weight: 700;
  font-size: 1.5rem;
}

.forecast-note {
  font-size: 0.68rem;
  color: var(--text-muted);
  margin-top: 0.75rem;
  font-style: italic;
}

/* Basin Table */
.basin-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1.5rem;
}

.basin-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

.basin-table th {
  font-family: var(--font-display);
  font-weight: 600;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  text-align: left;
  padding: 0.6rem 0.75rem;
  border-bottom: 1px solid var(--border);
}

.basin-table th:not(:first-child) { text-align: right; }

.basin-table td {
  padding: 0.7rem 0.75rem;
  border-bottom: 1px solid rgba(30, 48, 72, 0.5);
  color: var(--text-secondary);
}

.basin-table td:not(:first-child) {
  text-align: right;
  font-family: var(--font-display);
  font-weight: 600;
  font-size: 0.95rem;
}

.basin-table td:first-child {
  color: var(--text-primary);
  font-weight: 500;
}

.basin-table tr:last-child td { border-bottom: none; }

.basin-table tr:hover td { background: rgba(125, 211, 252, 0.03); }

.pct-badge {
  display: inline-block;
  padding: 0.15rem 0.5rem;
  border-radius: 2px;
  font-weight: 700;
  font-size: 0.85rem;
}

.pct-badge.critical { background: var(--danger-dim); color: var(--danger); }
.pct-badge.warning { background: var(--amber-dim); color: var(--amber); }
.pct-badge.ok { background: var(--green-dim); color: var(--green); }

/* Footer */
footer {
  margin-top: 2.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border);
  font-size: 0.72rem;
  color: var(--text-muted);
  line-height: 1.7;
}

footer a {
  color: var(--text-secondary);
  text-decoration: none;
}

/* Loading state */
.loading {
  text-align: center;
  padding: 3rem;
  color: var(--text-muted);
  font-size: 0.9rem;
}

/* View toggle buttons */
.view-toggle {
  display: inline-flex;
  background: var(--bg-deep);
  border: 1px solid var(--border);
  border-radius: 3px;
  overflow: hidden;
}

.view-toggle button {
  background: transparent;
  border: none;
  color: var(--text-muted);
  font-family: var(--font-display);
  font-size: 0.75rem;
  font-weight: 600;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  padding: 0.4rem 0.85rem;
  cursor: pointer;
  transition: all 0.15s;
}

.view-toggle button:not(:last-child) {
  border-right: 1px solid var(--border);
}

.view-toggle button.active {
  background: var(--ice-dim);
  color: var(--ice);
}

.view-toggle button:hover:not(.active) {
  color: var(--text-secondary);
}

/* Responsive */
@media (max-width: 900px) {
  .hero-grid { grid-template-columns: repeat(2, 1fr); }
  .analysis-grid { grid-template-columns: 1fr; }
  .hero-value { font-size: 2.2rem; }
  header h1 { font-size: 2rem; }
}

@media (max-width: 500px) {
  .hero-grid { grid-template-columns: 1fr; }
  .container { padding: 1rem; }
  .chart-wrapper { height: 300px; }
  .forecast-summary { grid-template-columns: 1fr; }
}

/* Legend overrides */
.legend-row {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  margin-top: 0.75rem;
  padding-top: 0.75rem;
  border-top: 1px solid var(--border);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.72rem;
  color: var(--text-secondary);
}

.legend-swatch {
  width: 18px;
  height: 3px;
  border-radius: 1px;
}

.legend-swatch.dashed {
  background: repeating-linear-gradient(90deg, currentColor 0px, currentColor 4px, transparent 4px, transparent 8px);
  height: 2px;
}

.legend-swatch-area {
  width: 18px;
  height: 10px;
  border-radius: 1px;
  opacity: 0.6;
}
</style>
</head>
<body>

<div class="container">
  <header>
    <div class="water-year-badge">Water Year <span id="wy"></span></div>
    <div class="header-row">
      <h1>Colorado Snowpack</h1>
      <div class="header-meta">
        <span id="station-count"></span> SNOTEL stations<br>
        Data fetched: <span id="fetch-time"></span>
      </div>
    </div>
  </header>

  <section class="hero-grid" id="hero-cards"></section>

  <section class="chart-section">
    <div class="chart-header">
      <div>
        <div class="chart-title" id="chart-title">Total Snowpack (Cumulative SWE)</div>
      </div>
      <div class="chart-controls">
        <select id="metric-select" class="year-select" style="max-width: 170px;">
          <option value="overall">Overall Score</option>
          <option value="swe" selected>Snowpack (SWE)</option>
          <option value="temp">Temperature</option>
          <option value="soil">Soil Moisture</option>
          <option value="wind">Wind Speed</option>
        </select>
        <select id="region-select" class="year-select" style="max-width: 220px;"></select>
        <label>
          <input type="checkbox" id="toggle-history" checked>
          Show historical years
        </label>
        <select id="year-select" class="year-select" multiple size="5"></select>
      </div>
    </div>
    <div class="chart-wrapper">
      <canvas id="swe-chart"></canvas>
    </div>
    <div class="legend-row" id="chart-legend">
      <div class="legend-item">
        <span class="legend-swatch" style="background: var(--ice);"></span>
        WY 2026 Actual
      </div>
      <div class="legend-item">
        <span class="legend-swatch dashed" style="color: #94A3B8;"></span>
        20-Year Median
      </div>
      <div class="legend-item">
        <span class="legend-swatch" style="background: rgba(248, 113, 113, 0.4);"></span>
        <span id="record-low-legend">Record Low</span>
      </div>
      <div class="legend-item">
        <span class="legend-swatch dashed" style="color: var(--amber);"></span>
        Catch-Up Pace
      </div>
      <div class="legend-item">
        <span class="legend-swatch-area" style="background: var(--ice);"></span>
        25th-75th Percentile
      </div>
      <div class="legend-item">
        <span class="legend-swatch-area" style="background: var(--ice); opacity: 0.3;"></span>
        10th-90th Percentile
      </div>
    </div>
  </section>

  <section class="analysis-grid">
    <div class="panel" id="catchup-panel">
      <div class="panel-title">Catch-Up Analysis</div>
      <div id="catchup-stats"></div>
      <div class="rate-compare" id="rate-compare"></div>
    </div>
    <div class="panel" id="forecast-panel">
      <div class="panel-title">7-Day Mountain Forecast</div>
      <div class="forecast-chart-wrapper">
        <canvas id="forecast-chart"></canvas>
      </div>
      <div class="forecast-summary" id="forecast-summary"></div>
      <div class="forecast-note" id="forecast-note"></div>
    </div>
  </section>

  <section class="basin-section">
    <div class="panel-title">Basin Breakdown</div>
    <table class="basin-table">
      <thead>
        <tr>
          <th>Basin</th>
          <th>Stations</th>
          <th>Current SWE</th>
          <th>Median</th>
          <th>% of Median</th>
          <th>Deficit</th>
        </tr>
      </thead>
      <tbody id="basin-tbody"></tbody>
    </table>
  </section>

  <section class="basin-section">
    <div class="panel-title">Basin Conditions (Temp, Wind, Soil Moisture)</div>
    <table class="basin-table">
      <thead>
        <tr>
          <th>Basin</th>
          <th>Avg Temp (24h)</th>
          <th>Avg Wind (24h)</th>
          <th>Wind Dir (now)</th>
          <th>Soil Moisture (0–1cm)</th>
        </tr>
      </thead>
      <tbody id="basin-conditions-tbody">
        <tr><td colspan="5" class="loading">Loading basin weather + soil conditions…</td></tr>
      </tbody>
    </table>
  </section>

  <footer>
    Snowpack data: NRCS SNOTEL AWDB REST API (119 stations, 1991-2020 medians via 20-year historical average) |
    Forecast & basin conditions: Open-Meteo API |
    SWE = Snow Water Equivalent (water content if snowpack melted) |
    Snow-to-SWE conversion uses approximate 12:1 ratio
  </footer>
</div>

<script>
// ============================================================
// Dashboard Initialization
// ============================================================

const S = DATA.summary;

// -- Header --
document.getElementById('wy').textContent = DATA.water_year;
document.getElementById('station-count').textContent = DATA.stations.count;
document.getElementById('fetch-time').textContent = new Date(DATA.generated_at).toLocaleDateString('en-US', {
  month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit'
});

// -- Hero Cards --
const heroHTML = [
  { cls: 'swe', label: 'Total Snowpack', value: S.current_swe.toFixed(1), unit: ' in', sub: `SWE as of ${new Date(S.today + 'T12:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} (statewide mean)` },
  { cls: 'deficit', label: 'Deficit', value: '-' + S.deficit_inches.toFixed(1), unit: ' in', sub: `vs ${S.median_swe_today.toFixed(1)} in median for today` },
  { cls: 'pct', label: '% of Median', value: S.pct_of_median.toFixed(0), unit: '%', sub: S.pct_of_median < 60 ? 'Record-low territory' : 'Below normal' },
  { cls: 'peak', label: 'Days to Peak', value: S.days_to_peak, unit: '', sub: `Median peak: ${new Date(S.median_peak_date + 'T12:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} (${S.median_peak_swe.toFixed(1)} in)` },
].map(c => `
  <div class="hero-card ${c.cls}">
    <div class="hero-label">${c.label}</div>
    <div class="hero-value">${c.value}<span class="hero-unit">${c.unit}</span></div>
    <div class="hero-sub">${c.sub}</div>
  </div>
`).join('');
document.getElementById('hero-cards').innerHTML = heroHTML;

// ============================================================
// Main Chart: multi-factor + region toggle
// ============================================================

const METRIC_META = {
  swe: { title: 'Snowpack (SWE)', unit: 'in', color: '#7DD3FC' },
  overall: { title: 'Overall Snowpack Health Score', unit: 'score', color: '#4ADE80' },
  temp: { title: '24h Avg Temperature', unit: '°F', color: '#FBBF24' },
  soil: { title: '24h Avg Soil Moisture (0-1cm)', unit: '%', color: '#4ADE80' },
  wind: { title: '24h Avg Wind Speed', unit: 'mph', color: '#C084FC' },
};

const REGION_NAMES = ['Colorado (Statewide)', ...Object.keys(DATA.basins || {}).sort()];
const regionSelect = document.getElementById('region-select');
REGION_NAMES.forEach(name => {
  const opt = document.createElement('option');
  opt.value = name;
  opt.textContent = name;
  regionSelect.appendChild(opt);
});
regionSelect.value = 'Colorado (Statewide)';

const metricSelect = document.getElementById('metric-select');
const histToggle = document.getElementById('toggle-history');
const yearSelect = document.getElementById('year-select');

const years = Object.keys(DATA.historical_years).sort();
years.forEach(yr => {
  const opt = document.createElement('option');
  opt.value = yr;
  opt.textContent = `WY ${yr}`;
  if (['2012', '2018', '2025'].includes(yr)) opt.selected = true;
  yearSelect.appendChild(opt);
});

const histColors = [
  '#4B5563', '#6B7280', '#9CA3AF', '#374151', '#5C6370', '#485563', '#6A737D', '#8B949E'
];

function percentileRank(sortedVals, x) {
  if (!sortedVals.length) return null;
  let le = 0;
  for (const v of sortedVals) if (v <= x) le++;
  return (le / sortedVals.length) * 100;
}

function movingDelta(values, i, window = 14) {
  if (i < window) return null;
  const a = values[i - window];
  const b = values[i];
  if (!Number.isFinite(a) || !Number.isFinite(b)) return null;
  return b - a;
}

function getRegionSeries(region) {
  if (region === 'Colorado (Statewide)') {
    return {
      current: DATA.current_season,
      historical: DATA.historical_years,
    };
  }
  return {
    current: (DATA.basin_current_series || {})[region],
    historical: (DATA.basin_historical_years || {})[region],
  };
}

function computeOverallScoreSeries(region) {
  const series = getRegionSeries(region);
  if (!series.current || !series.historical) return null;

  const curDates = series.current.dates || [];
  const curSwe = series.current.swe || [];

  const byDoyVals = {};
  const byDoyMom = {};

  Object.values(series.historical).forEach(curve => {
    const vals = curve.swe || [];
    vals.forEach((v, i) => {
      if (!Number.isFinite(v)) return;
      if (!byDoyVals[i]) byDoyVals[i] = [];
      byDoyVals[i].push(v);
      const mom = movingDelta(vals, i, 14);
      if (mom != null) {
        if (!byDoyMom[i]) byDoyMom[i] = [];
        byDoyMom[i].push(mom);
      }
    });
  });

  Object.values(byDoyVals).forEach(arr => arr.sort((a, b) => a - b));
  Object.values(byDoyMom).forEach(arr => arr.sort((a, b) => a - b));

  const out = curDates.map((d, i) => {
    const swe = curSwe[i];
    const swePct = Number.isFinite(swe) && byDoyVals[i] ? percentileRank(byDoyVals[i], swe) : null;
    const mom = movingDelta(curSwe, i, 14);
    const momPct = mom != null && byDoyMom[i] ? percentileRank(byDoyMom[i], mom) : null;

    const sweScore = swePct ?? 50;
    const momentumScore = momPct ?? 50;

    // Catch-up score proxy: penalize large deficits vs same-day historical median
    const histMedian = byDoyVals[i]?.[Math.floor((byDoyVals[i].length - 1) / 2)] ?? swe;
    const deficit = Math.max(0, (histMedian ?? 0) - (swe ?? 0));
    const catchupScore = Math.max(0, 100 - deficit * 8);

    const score = 0.55 * sweScore + 0.30 * momentumScore + 0.15 * catchupScore;
    return { x: d, y: Math.max(0, Math.min(100, score)) };
  });

  return out;
}

async function fetchBasinRecentConditions(region) {
  const centroids = buildBasinCentroids();
  let c;
  if (region === 'Colorado (Statewide)') {
    const vals = Object.values(centroids);
    const lat = vals.reduce((a, v) => a + v.lat, 0) / vals.length;
    const lon = vals.reduce((a, v) => a + v.lon, 0) / vals.length;
    c = { lat, lon };
  } else {
    c = centroids[region];
  }
  if (!c) throw new Error('No centroid available');

  const url = `https://api.open-meteo.com/v1/forecast?latitude=${c.lat.toFixed(4)}&longitude=${c.lon.toFixed(4)}&hourly=temperature_2m,wind_speed_10m,soil_moisture_0_to_1cm&past_days=7&forecast_days=1&timezone=America/Denver`;
  const r = await fetch(url);
  const j = await r.json();
  if (!j.hourly) throw new Error('No weather data');

  const points = (j.hourly.time || []).map((t, i) => ({
    x: t,
    temp: j.hourly.temperature_2m?.[i],
    wind: j.hourly.wind_speed_10m?.[i],
    soil: j.hourly.soil_moisture_0_to_1cm?.[i],
  }));

  return points;
}

let cachedWeather = {};
let currentMetric = 'swe';
let currentRegion = 'Colorado (Statewide)';

function buildSweDatasets(region) {
  const series = getRegionSeries(region);
  if (!series.current) return [];

  const currentPts = (series.current.dates || []).map((d, i) => ({ x: d, y: series.current.swe[i] }));
  const medianPts = (series.current.dates || []).map((d, i) => ({ x: d, y: series.current.median[i] }));

  const datasets = [
    {
      label: `WY ${DATA.water_year} ${region === 'Colorado (Statewide)' ? 'Actual' : region}`,
      data: currentPts,
      borderColor: METRIC_META.swe.color,
      borderWidth: 2.4,
      fill: false,
      pointRadius: 0,
      tension: 0.15,
    },
    {
      label: 'Median',
      data: medianPts,
      borderColor: '#94A3B8',
      borderDash: [6, 4],
      borderWidth: 1.5,
      fill: false,
      pointRadius: 0,
      tension: 0.15,
    },
  ];

  if (histToggle.checked) {
    const selected = Array.from(yearSelect.selectedOptions).map(o => o.value);
    selected.forEach((yr, i) => {
      const yd = (series.historical || {})[yr];
      if (!yd) return;
      datasets.push({
        label: `WY ${yr}`,
        data: yd.dates.map((d, j) => ({ x: d, y: yd.swe[j] })),
        borderColor: histColors[i % histColors.length],
        borderWidth: 1,
        fill: false,
        pointRadius: 0,
        tension: 0.12,
      });
    });
  }

  return datasets;
}

async function renderMainChart() {
  const meta = METRIC_META[currentMetric];
  const chartTitle = document.getElementById('chart-title');
  chartTitle.textContent = `${meta.title} — ${currentRegion}`;

  const legend = document.getElementById('chart-legend');
  legend.style.display = 'flex';

  let datasets = [];
  let yLabel = meta.unit;

  if (currentMetric === 'swe') {
    datasets = buildSweDatasets(currentRegion);
    yLabel = 'SWE (inches)';
  } else if (currentMetric === 'overall') {
    const scorePts = computeOverallScoreSeries(currentRegion) || [];
    datasets = [{
      label: `Overall Score (${currentRegion})`,
      data: scorePts,
      borderColor: METRIC_META.overall.color,
      borderWidth: 2.4,
      fill: false,
      pointRadius: 0,
      tension: 0.2,
    }];
    if (histToggle.checked) {
      const series = getRegionSeries(currentRegion);
      const selected = Array.from(yearSelect.selectedOptions).map(o => o.value);
      selected.forEach((yr, i) => {
        const yd = (series.historical || {})[yr];
        if (!yd) return;
        const fauxCurrent = { dates: yd.dates, swe: yd.swe };
        const byDoy = {};
        Object.values(series.historical || {}).forEach(cur => (cur.swe || []).forEach((v, idx) => { if (!byDoy[idx]) byDoy[idx] = []; byDoy[idx].push(v); }));
        Object.values(byDoy).forEach(arr => arr.sort((a,b)=>a-b));
        const pts = fauxCurrent.dates.map((d, idx) => ({ x: d, y: percentileRank(byDoy[idx] || [], fauxCurrent.swe[idx]) ?? 50 }));
        datasets.push({
          label: `WY ${yr} Score`,
          data: pts,
          borderColor: histColors[i % histColors.length],
          borderWidth: 1,
          fill: false,
          pointRadius: 0,
          tension: 0.1,
        });
      });
    }
    yLabel = 'Score (0-100)';
  } else {
    const key = `${currentRegion}`;
    if (!cachedWeather[key]) cachedWeather[key] = await fetchBasinRecentConditions(currentRegion);
    const weather = cachedWeather[key];
    const mapFn = currentMetric === 'temp'
      ? (p) => Number.isFinite(p.temp) ? (p.temp * 9 / 5 + 32) : null
      : currentMetric === 'wind'
        ? (p) => Number.isFinite(p.wind) ? (p.wind * 0.621371) : null
        : (p) => Number.isFinite(p.soil) ? (p.soil * 100) : null;

    datasets = [{
      label: `${meta.title} (${currentRegion})`,
      data: weather.map(p => ({ x: p.x, y: mapFn(p) })).filter(p => p.y != null),
      borderColor: meta.color,
      borderWidth: 2,
      fill: false,
      pointRadius: 0,
      tension: 0.2,
    }];
    yLabel = meta.unit;
  }

  if (window.sweChart) window.sweChart.destroy();

  const ctx = document.getElementById('swe-chart').getContext('2d');
  window.sweChart = new Chart(ctx, {
    type: 'line',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: {
          type: 'time',
          time: { unit: currentMetric === 'swe' || currentMetric === 'overall' ? 'month' : 'day' },
          grid: { color: 'rgba(255,255,255,0.04)' },
          ticks: { color: '#556677', font: { family: 'Barlow Condensed', size: 12 } },
        },
        y: {
          beginAtZero: currentMetric !== 'temp',
          max: currentMetric === 'overall' ? 100 : undefined,
          title: {
            display: true,
            text: yLabel,
            color: '#556677',
            font: { family: 'Barlow Condensed', size: 12 },
          },
          grid: { color: 'rgba(255,255,255,0.04)' },
          ticks: { color: '#556677', font: { family: 'Barlow Condensed', size: 12 } },
        },
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#111D2E',
          borderColor: '#1E3048',
          borderWidth: 1,
          titleColor: '#E8EDF3',
          bodyColor: '#8899AE',
          titleFont: { family: 'Barlow Condensed', weight: '600' },
          bodyFont: { family: 'DM Sans' },
          padding: 12,
          callbacks: {
            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed( currentMetric === 'overall' ? 0 : 2 )} ${currentMetric === 'overall' ? '' : meta.unit}`.trim(),
          },
        },
      },
    },
  });

  legend.innerHTML = datasets.map(ds => `
    <div class="legend-item">
      <span class="legend-swatch" style="background:${ds.borderColor};"></span>
      ${ds.label}
    </div>
  `).join('');

  const sweMode = currentMetric === 'swe' || currentMetric === 'overall';
  histToggle.parentElement.style.display = sweMode ? '' : 'none';
  yearSelect.style.display = sweMode && histToggle.checked ? 'block' : 'none';
}

metricSelect.addEventListener('change', async (e) => {
  currentMetric = e.target.value;
  await renderMainChart();
});
regionSelect.addEventListener('change', async (e) => {
  currentRegion = e.target.value;
  await renderMainChart();
});
histToggle.addEventListener('change', async () => {
  yearSelect.style.display = histToggle.checked ? 'block' : 'none';
  await renderMainChart();
});
yearSelect.addEventListener('change', renderMainChart);

renderMainChart();

// Historical comparison note (replacing record-low legend behavior)
document.getElementById('record-low-legend').textContent = 'Historical overlays selectable (left controls)';

// ============================================================

// Catch-Up Panel
// ============================================================

const rateMultiple = S.actual_daily_rate_30d > 0
  ? (S.daily_rate_needed / S.actual_daily_rate_30d).toFixed(1)
  : '--';

document.getElementById('catchup-stats').innerHTML = `
  <div class="catchup-stat">
    <span class="catchup-stat-label">SWE needed to reach median peak</span>
    <span class="catchup-stat-value" style="color: var(--amber);">${S.swe_needed_for_peak.toFixed(1)}<span class="hero-unit"> in</span></span>
  </div>
  <div class="catchup-stat">
    <span class="catchup-stat-label">Daily rate needed</span>
    <span class="catchup-stat-value">${S.daily_rate_needed.toFixed(3)}<span class="hero-unit"> in/day</span></span>
  </div>
  <div class="catchup-stat">
    <span class="catchup-stat-label">Actual 30-day rate</span>
    <span class="catchup-stat-value" style="color: var(--ice);">${S.actual_daily_rate_30d.toFixed(3)}<span class="hero-unit"> in/day</span></span>
  </div>
  <div class="catchup-stat">
    <span class="catchup-stat-label">Rate multiple needed</span>
    <span class="catchup-stat-value" style="color: var(--danger);">${rateMultiple}<span class="hero-unit">x</span></span>
  </div>
  <div class="catchup-stat">
    <span class="catchup-stat-label">% of normal remaining needed</span>
    <span class="catchup-stat-value" style="color: var(--danger);">${S.pct_of_normal_remaining_needed.toFixed(0)}<span class="hero-unit">%</span></span>
  </div>
`;

// Rate comparison bars
const maxRate = Math.max(S.daily_rate_needed, S.actual_daily_rate_30d);
const neededPct = maxRate > 0 ? (S.daily_rate_needed / maxRate) * 100 : 0;
const actualPct = maxRate > 0 ? (S.actual_daily_rate_30d / maxRate) * 100 : 0;

document.getElementById('rate-compare').innerHTML = `
  <div class="rate-bar-group">
    <div class="rate-bar-label">
      <span>Needed pace</span>
      <span>${S.daily_rate_needed.toFixed(3)} in/day</span>
    </div>
    <div class="rate-bar-track">
      <div class="rate-bar-fill needed" style="width: ${neededPct}%;"></div>
    </div>
  </div>
  <div class="rate-bar-group">
    <div class="rate-bar-label">
      <span>Actual 30-day pace</span>
      <span>${S.actual_daily_rate_30d.toFixed(3)} in/day</span>
    </div>
    <div class="rate-bar-track">
      <div class="rate-bar-fill actual" style="width: ${actualPct}%;"></div>
    </div>
  </div>
`;

// ============================================================
// 7-Day Forecast (from Open-Meteo)
// ============================================================

async function loadForecast() {
  const points = DATA.forecast_points;

  try {
    const promises = points.map(pt =>
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pt.lat}&longitude=${pt.lon}&daily=snowfall_sum,precipitation_sum,temperature_2m_min&forecast_days=7&timezone=America/Denver`)
        .then(r => r.json())
    );
    const results = await Promise.all(promises);

    const dates = results[0].daily.time;
    const numDays = dates.length;

    // Average snowfall and precipitation across mountain points
    const avgSnowfall = new Array(numDays).fill(0);
    const avgPrecip = new Array(numDays).fill(0);
    const avgTempMin = new Array(numDays).fill(0);
    let validCount = 0;

    results.forEach(r => {
      if (!r.daily) return;
      validCount++;
      for (let i = 0; i < numDays; i++) {
        avgSnowfall[i] += (r.daily.snowfall_sum[i] || 0);
        avgPrecip[i] += (r.daily.precipitation_sum[i] || 0);
        avgTempMin[i] += (r.daily.temperature_2m_min[i] || 0);
      }
    });

    if (validCount === 0) throw new Error('No forecast data');

    for (let i = 0; i < numDays; i++) {
      avgSnowfall[i] /= validCount;
      avgPrecip[i] /= validCount;
      avgTempMin[i] /= validCount;
    }

    // Convert snowfall from cm to inches
    const snowfallInches = avgSnowfall.map(cm => cm / 2.54);

    // Estimate SWE: use precipitation when temp < 2C, else use snowfall/12 ratio
    const sweEstimate = dates.map((_, i) => {
      if (avgTempMin[i] < 2) {
        // Precipitation as mm -> inches of water (SWE)
        return avgPrecip[i] / 25.4;
      }
      return snowfallInches[i] / 12;
    });

    const totalSnowfall = snowfallInches.reduce((a, b) => a + b, 0);
    const totalSwe = sweEstimate.reduce((a, b) => a + b, 0);
    const neededSwe7d = S.daily_rate_needed * 7;

    // Render forecast bar chart
    const fctx = document.getElementById('forecast-chart').getContext('2d');
    new Chart(fctx, {
      type: 'bar',
      data: {
        labels: dates.map(d => {
          const dt = new Date(d + 'T12:00');
          return dt.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }),
        datasets: [{
          label: 'Snowfall (in)',
          data: snowfallInches,
          backgroundColor: snowfallInches.map(v => v > 2 ? 'rgba(125, 211, 252, 0.7)' : 'rgba(125, 211, 252, 0.35)'),
          borderColor: 'rgba(125, 211, 252, 0.9)',
          borderWidth: 1,
          borderRadius: 2,
        }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#111D2E',
            borderColor: '#1E3048',
            borderWidth: 1,
            titleColor: '#E8EDF3',
            bodyColor: '#8899AE',
            titleFont: { family: 'Barlow Condensed' },
            bodyFont: { family: 'DM Sans' },
            callbacks: {
              label: (ctx) => `${ctx.parsed.y.toFixed(1)} inches snowfall`,
            },
          },
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: {
              color: '#556677',
              font: { family: 'Barlow Condensed', size: 11 },
              maxRotation: 45,
            },
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Snowfall (in)',
              color: '#556677',
              font: { family: 'Barlow Condensed', size: 11 },
            },
            grid: { color: 'rgba(255,255,255,0.04)' },
            ticks: {
              color: '#556677',
              font: { family: 'Barlow Condensed', size: 11 },
            },
          },
        },
      },
    });

    // Forecast summary stats
    document.getElementById('forecast-summary').innerHTML = `
      <div class="forecast-stat">
        <div class="forecast-stat-label">7-Day Snowfall</div>
        <div class="forecast-stat-value" style="color: var(--ice);">${totalSnowfall.toFixed(1)}<span class="hero-unit"> in</span></div>
      </div>
      <div class="forecast-stat">
        <div class="forecast-stat-label">Est. SWE Added</div>
        <div class="forecast-stat-value" style="color: ${totalSwe >= neededSwe7d * 0.5 ? 'var(--green)' : 'var(--amber)'};">${totalSwe.toFixed(2)}<span class="hero-unit"> in</span></div>
      </div>
      <div class="forecast-stat">
        <div class="forecast-stat-label">Needed (7d at pace)</div>
        <div class="forecast-stat-value">${neededSwe7d.toFixed(2)}<span class="hero-unit"> in</span></div>
      </div>
      <div class="forecast-stat">
        <div class="forecast-stat-label">Forecast vs Need</div>
        <div class="forecast-stat-value" style="color: ${totalSwe >= neededSwe7d ? 'var(--green)' : 'var(--danger)'};">${neededSwe7d > 0 ? (totalSwe / neededSwe7d * 100).toFixed(0) : '--'}<span class="hero-unit">%</span></div>
      </div>
    `;

    document.getElementById('forecast-note').textContent =
      `Averaged from ${validCount} mountain locations. SWE estimated from precipitation when min temp < 2C.`;

  } catch (err) {
    document.getElementById('forecast-panel').querySelector('.forecast-chart-wrapper').innerHTML =
      `<div class="loading">Forecast unavailable: ${err.message}</div>`;
  }
}

loadForecast();

// ============================================================
// Basin Table
// ============================================================

const basins = Object.entries(DATA.basins)
  .sort((a, b) => a[1].pct_of_median - b[1].pct_of_median);

const basinRows = basins.map(([name, b]) => {
  const pctClass = b.pct_of_median < 50 ? 'critical' : b.pct_of_median < 70 ? 'warning' : 'ok';
  return `
    <tr>
      <td>${name}</td>
      <td>${b.station_count}</td>
      <td>${b.current_swe.toFixed(1)} in</td>
      <td>${b.median_swe_today.toFixed(1)} in</td>
      <td><span class="pct-badge ${pctClass}">${b.pct_of_median.toFixed(0)}%</span></td>
      <td style="color: var(--danger);">-${b.deficit_inches.toFixed(1)} in</td>
    </tr>
  `;
}).join('');

document.getElementById('basin-tbody').innerHTML = basinRows;

// ============================================================
// Basin Conditions (Open-Meteo)
// ============================================================

function cardinalFromDeg(deg) {
  if (deg == null || Number.isNaN(deg)) return '--';
  const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
  return dirs[Math.round(deg / 45) % 8];
}

function mean(arr) {
  if (!arr || !arr.length) return null;
  const valid = arr.filter(v => Number.isFinite(v));
  if (!valid.length) return null;
  return valid.reduce((a, b) => a + b, 0) / valid.length;
}

function buildBasinCentroids() {
  const byBasin = {};
  (DATA.stations.list || []).forEach(st => {
    if (!st.basin || !Number.isFinite(st.lat) || !Number.isFinite(st.lon)) return;
    if (!byBasin[st.basin]) byBasin[st.basin] = { lat: [], lon: [] };
    byBasin[st.basin].lat.push(st.lat);
    byBasin[st.basin].lon.push(st.lon);
  });

  const centroids = {};
  Object.entries(byBasin).forEach(([basin, pts]) => {
    centroids[basin] = {
      lat: mean(pts.lat),
      lon: mean(pts.lon),
    };
  });
  return centroids;
}

async function loadBasinConditions() {
  const tbody = document.getElementById('basin-conditions-tbody');
  const centroids = buildBasinCentroids();
  const basinNames = Object.keys(DATA.basins || {});

  try {
    const rows = await Promise.all(basinNames.map(async (basin) => {
      const c = centroids[basin];
      if (!c) return { basin, error: 'No centroid' };

      const url = `https://api.open-meteo.com/v1/forecast?latitude=${c.lat.toFixed(4)}&longitude=${c.lon.toFixed(4)}&hourly=temperature_2m,wind_speed_10m,wind_direction_10m,soil_moisture_0_to_1cm&past_days=1&forecast_days=1&timezone=America/Denver`;
      const r = await fetch(url);
      const j = await r.json();

      if (!j.hourly) return { basin, error: 'No data' };

      const temp = mean(j.hourly.temperature_2m);
      const wind = mean(j.hourly.wind_speed_10m);
      const soil = mean(j.hourly.soil_moisture_0_to_1cm);
      const dirSeries = j.hourly.wind_direction_10m || [];
      const currentDir = dirSeries.length ? dirSeries[dirSeries.length - 1] : null;

      return {
        basin,
        avgTempC: temp,
        avgTempF: temp != null ? (temp * 9 / 5) + 32 : null,
        avgWindMph: wind != null ? wind * 0.621371 : null,
        windDir: cardinalFromDeg(currentDir),
        soilPct: soil != null ? soil * 100 : null,
      };
    }));

    const sorted = rows.sort((a, b) => a.basin.localeCompare(b.basin));

    tbody.innerHTML = sorted.map(r => {
      if (r.error) {
        return `<tr><td>${r.basin}</td><td colspan="4" class="loading">Unavailable (${r.error})</td></tr>`;
      }
      return `
        <tr>
          <td>${r.basin}</td>
          <td>${r.avgTempF != null ? r.avgTempF.toFixed(1) : '--'}°F</td>
          <td>${r.avgWindMph != null ? r.avgWindMph.toFixed(1) : '--'} mph</td>
          <td>${r.windDir}</td>
          <td>${r.soilPct != null ? r.soilPct.toFixed(1) : '--'}%</td>
        </tr>
      `;
    }).join('');
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="5" class="loading">Basin conditions unavailable: ${err.message}</td></tr>`;
  }
}

loadBasinConditions();

</script>
</body>
</html>
